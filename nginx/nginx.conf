# nginx/nginx.conf

# Define an upstream server block for the Gunicorn application.
# This allows Nginx to know where to forward dynamic traffic.
# 'service-backend' is the service name defined in docker-compose.yml,
# and Docker's internal DNS will resolve it to the correct container IP.
# '8000' is the port that Gunicorn is running on inside its container.
upstream django_server {
    server service-backend:8000;
}

# The main server block that listens for incoming connections on port 80 (HTTP).
server {
    listen 80;
    server_name localhost; # Can be replaced with your domain name.

    # Increase the maximum allowed size of the client request body.
    # This is useful for file uploads.
    client_max_body_size 20M;

    # --- Location block for static files ---
    # This block tells Nginx how to handle requests for static assets (CSS, JS, images).
    # The 'alias' directive maps the URL path '/static/' to the '/app/staticfiles/' directory
    # inside the Nginx container. This directory will be populated by the shared volume
    # that is also mounted in the Django container.
    location /static/ {
        alias /app/staticfiles/;
        expires 30d; # Cache static files in the browser for 30 days.
        add_header Cache-Control "public";
    }

    # --- Location block for media files (user uploads) ---
    # This block handles requests for user-uploaded content.
    # It maps the '/media/' URL to the '/app/media/' directory.
    location /media/ {
        alias /app/media/;
        expires 30d;
        add_header Cache-Control "public";
    }

    # --- Location block for all other requests (dynamic content) ---
    # This is the "catch-all" block that forwards all other requests to the Gunicorn server.
    location / {
        # Pass the request to the upstream Gunicorn server.
        proxy_pass http://django_server;

        # Set headers to pass necessary information to the backend application.
        # This ensures the Django app knows the original host, IP, and protocol of the request.
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Redirects should be handled by the upstream.
        proxy_redirect off;
    }
}
